# SSL/TLS Handshake

## 0. 선요약
SSL 암호화 통신은 'SSL(Secure Socket Layer)' 또는 'TLS(Transport Layer Security)'라는 보안 프로토콜을 통해 보안이 향상된 통신을 하는 것.
HTTPS 프로토콜은 HTTP에 이런 암호화 통신이 적용된 버전으로, HTTP 요청 및 응답을 SSL/TLS 기술에 결합한다.
HTTPS 웹 사이트는 독립된 인증 기관 (CA)에서 SSL/TLS 인증서를 획득해야 한다. 이 인증서를 통해 유저는 통신하려는 서버가 안전한지 확인할 수 있다. (가짜 네이버인지, 진짜 네이버인지 확인 가능)
암호화가 적용되어, 중간에 탈취되어도 텍스트를 해독할 수 없고 이러한 내용물 암호화엔 대칭키가 사용된다. (Session Key)

<br> 

여기까지가 간단 요약이고, 이제 자세히 설명해보자.
잊지 말아야 할 점은, 아래의 과정들은 당연히 TCP 연결을 위한 3-way-handshake 이후 진행된다는 점이다.

## 1. 대칭키와 비대칭키
대칭키와 비대칭키는 암호화를 위해 쓰이는 키로,
1. `대칭키` : 키 하나로 암호화, 복호화 모두가 가능
2. `비대칭키` : 두 개의 키 쌍을 이용하는데, 한 가지 키로 암호화 한다면 나머지 하나의 키로 복호화 할 수 있다. <br> 비대칭키는 **둘 중 하나를 알아도, 나머지 하나를 추측하기 굉장히 어렵다**. <br> 이 점을 이용해 보통 하나는 공개하고, 하나는 숨겨서 사용하는데, **이를 각각 공개키(Public Key) 개인키(비밀키)라고 부른다.** 앞서 설명한 것처럼 공개키로 암호화 했다면, 비밀키로 복호화할 수 있고, 비밀키로 암호화 했다면, 개인키로 복호화 할 수 있다. ([알고리즘 참고](https://retro-blue.tistory.com/39))

<br>

#### ✔️ 서버-클라이언트 통신 암호화는 대칭키로 이루어지는 이유?
대칭키의 암-복호화 속도 차이는 보통 비대칭키 보다 1000배 정도 빠르다고 한다. 따라서, HTTPS 연결이 성립되기 전의 과정들에선 비대칭키로 암-복호화를 진행되지만, 연결 성립 이후엔 대칭키를 통해 암호화를 한다.
당연하게도, 대칭키는 탈취되는 순간 엄청 위험하다. 그렇다면 어떻게 서버와 클라이언트가 안전하게 대칭키를 주고 받을까?
<br>

## 2. 서버의 SSL/TLS 인증서 발급 과정
서버는 제 3의 인증 기관 CA에 SSL/TLS 인증서 발급을 요청한다. 이 인증서는 우리 서버가 클라이언트에게 안전하다는 것을 증명한다. 
예를 들어, 네이버에 접속한 유저가 이 사이트가 진짜 네이버인지 아니면 나쁜 사람이 만든 가짜 네이버인지 확인할 수 있게 해준다.
**서버는 자신의 `도메인 이름`과 `공개키`가 포함된 인증서를 발급해달라고, CA 기관에 요청한다** (인증서는 CA의 개인키로 암호화 되어있다.)

<br>

#### ✔️ 인증서 안에 `도메인 이름`과 `서버 공개키`가 포함된 이유?
`도메인 이름`이 있어야 사용자가 통신중인 사이트가 진짜인지 확인할 수 있고, `공개키`는 서버와 대칭키를 주고 받을 때 암호화를 위해 쓰인다.**
이런 **인증서를 전적으로 믿고 통신하는 만큼 CA의 신뢰성도 아주 중요하다!**
- **그리고 인증서는 CA의 개인키로 암호화 되어있다.** 

<br>

#### ✔️ 인증서가 CA 개인키로 암호화된 이유? 
**-> CA의 공개키로 복호화했을 때 정상적으로 복호화되는지 확인함으로써, CA기업에서 발급한 것이 맞는지 확인하기 위함임.**

<br>

## 3. HTTPS 연결 과정

![image](https://github.com/binary-ho/Save-Me-Speedwagon/assets/71186266/30102c21-1818-4973-a87d-8b105b471dd7)

<br>

1. **일단 당연하게도 TCP 연결을 위한 3-way-handshake가 먼저 이루어진다.**
2. Client Hello, Server Hello : 서버에게 인증서를 요청하고, 받아낸다. (서버를 검증하기 위해. 인증서는 CA기관의 개인키로 암호화 되어있다.) <br> 서버는 인증서와 어떤 난수를 보내준다. ([더 자세한 설명](https://jaeseongdev.github.io/development/2021/07/02/HTTPS,SSL,TLS/))

#### ✔️ 3. **인증서 검증 과정**
인증서를 CA의 공개키로 복호화한다.
- 정상적으로 복호화가 안 된다면 CA기업이 발급한 인증서가 아님
- 복호화하면 인증서에 `서버 도메인 이름`이 적혀있는데, 현재 통신중인 도메인과 이 도메인이 같은지 확인. <br> **✔️ 악의적인 사이트가 다른 사이트의 인증서를 이용할 수도 있기 때문** <br>
(이러한 CA 공개키는 브라우저에 내장)

<br>

4. **대칭키 만들기 - Session Key**
인증서 안에 있는 **`서버 공개키`와 Hello 과정에서 Client와 Server가 각각 만든 랜덤 값들을 이용해서 대칭키 하나를 만들어 내는데, 이를 Session Key라고도 부른다.** (랜덤 값들을 서버 공개키로 암호화한 값을 쓴다)
이제 부터 이 대칭키로 통신을 할 건데, **대칭키를 전해줄 때는 서버의 공개키로 암호화 한다.** (공개키를 보호하기 위함)
서버에서 세션키를 전달 받으면 연결은 성립된다. 이제 이 세션키로 통신하면 안전한 통신이 가능하다. 
